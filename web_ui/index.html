<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAR Scanner - Live Dashboard</title>
    
    <!-- Leaflet CSS for maps (bundled locally for offline operation) -->
    <link rel="stylesheet" href="/static/css/leaflet.min.css" />
    
    <!-- Font Awesome for icons (bundled locally for offline operation) -->
    <link rel="stylesheet" href="/static/css/fontawesome.min.css" />
    
    <style>
        /* Red Cross Color Scheme */
        :root {
            --rc-red: #C60C30;
            --rc-dark-red: #A00826;
            --rc-white: #FFFFFF;
            --rc-black: #1a1a1a;
            --rc-light-gray: #f5f5f5;
            --rc-dark-gray: #333333;
            --accent-blue: #0066cc;
            --accent-green: #2ecc71;
            --accent-orange: #e67e22;
            --accent-red-light: #e74c3c;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--rc-light-gray);
            color: var(--rc-black);
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 0;
            padding: 0;
            background: var(--rc-light-gray);
        }

        /* Resizable divider */
        .divider {
            width: 5px;
            background: var(--rc-red);
            cursor: col-resize;
            transition: background 0.2s;
            z-index: 100;
            flex-shrink: 0;
        }

        .divider:hover {
            background: var(--rc-dark-red);
            box-shadow: 0 0 5px rgba(198, 12, 48, 0.5);
        }

        .sidebar {
            width: 550px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            padding: 10px;
            background: var(--rc-white);
            border-right: 2px solid var(--rc-red);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 10px;
        }

        .panel {
            background: var(--rc-white);
            border: 2px solid var(--rc-red);
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel-title {
            font-size: 13px;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--rc-white);
            background: var(--rc-red);
            margin: -12px -12px 10px -12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 2px 2px 0 0;
        }

        /* Indicators */
        .indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .indicator {
            background: var(--rc-light-gray);
            border-left: 4px solid var(--rc-red);
            padding: 10px;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: all 0.3s;
        }

        .indicator.active {
            background: #e8f5e9;
            border-left-color: var(--accent-green);
        }

        .indicator.inactive {
            background: #ffebee;
            border-left-color: var(--accent-red-light);
        }

        .indicator-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        .indicator-value {
            font-size: 13px;
            font-weight: bold;
        }

        .indicator-value.good {
            color: var(--accent-green);
        }

        .indicator-value.warning {
            color: var(--accent-orange);
        }

        .indicator-value.error {
            color: var(--accent-red-light);
        }

        /* Live time */
        #liveTime {
            font-size: 28px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-align: center;
            color: var(--rc-white);
            background: var(--rc-red);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--rc-red);
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--rc-light-gray);
            border: 1px solid var(--rc-red);
            color: var(--rc-black);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 11px;
            border-radius: 2px 2px 0 0;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--rc-red);
            color: var(--rc-white);
            border-color: var(--rc-dark-red);
        }

        .tab-btn:hover {
            background: var(--rc-red);
            color: var(--rc-white);
        }

        /* Tables */
        .table-container {
            overflow-y: auto;
            flex: 1;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 2px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--rc-red);
            color: var(--rc-white);
            padding: 8px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid var(--rc-dark-red);
        }

        td {
            padding: 7px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #fff3e0;
        }

        /* Interactive row for WiFi devices */
        tbody#wifiDevicesTable tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        tbody#wifiDevicesTable tr.selected {
            background: #c8e6c9 !important;
            border-left: 4px solid var(--accent-green);
            font-weight: 500;
        }

        /* Interactive row for BT devices */
        tbody#btDevicesTable tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        tbody#btDevicesTable tr.selected {
            background: #e3f2fd !important;
            border-left: 4px solid var(--accent-blue);
            font-weight: 500;
        }

        /* Device tooltip/popup */
        .device-tooltip {
            position: fixed;
            background: var(--rc-white);
            border: 2px solid var(--rc-red);
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            font-size: 11px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            pointer-events: auto;
            display: none;
        }

        .device-tooltip.show {
            display: block;
        }

        .device-tooltip-title {
            font-weight: bold;
            color: var(--rc-white);
            background: var(--rc-red);
            margin: -12px -12px 8px -12px;
            padding: 8px 12px;
            border-radius: 2px 2px 0 0;
        }

        .device-tooltip-row {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
        }

        .device-tooltip-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .device-tooltip-label {
            font-weight: bold;
            color: var(--rc-red);
            min-width: 60px;
        }

        .device-tooltip-value {
            word-break: break-all;
            color: var(--rc-black);
        }

        .device-tooltip-ssids {
            margin-top: 8px;
        }

        .device-tooltip-ssids-title {
            font-weight: bold;
            color: var(--rc-red);
            margin-bottom: 4px;
        }

        .device-tooltip-ssid-item {
            background: #f5f5f5;
            padding: 4px 6px;
            margin: 2px 0;
            border-radius: 2px;
            border-left: 3px solid var(--accent-blue);
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .device-tooltip-close {
            float: right;
            cursor: pointer;
            font-weight: bold;
            color: var(--rc-white);
            background: rgba(0, 0, 0, 0.2);
            border: none;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
        }

        .device-tooltip-close:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .mac-addr {
            font-family: 'Courier New', monospace;
            color: var(--rc-red);
            font-weight: 500;
        }

        .rssi-bar {
            display: inline-block;
            width: 50px;
            height: 14px;
            background: #ddd;
            border-radius: 2px;
            border: 1px solid #999;
            overflow: hidden;
            position: relative;
            margin-right: 4px;
        }

        .rssi-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #e67e22, var(--accent-green));
            width: 100%;
            transition: width 0.3s;
        }

        .confidence-bar {
            display: inline-block;
            width: 50px;
            height: 14px;
            background: #ddd;
            border-radius: 2px;
            border: 1px solid #999;
            overflow: hidden;
            position: relative;
            margin-right: 4px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #e67e22, var(--accent-green));
            width: 100%;
            transition: width 0.3s;
        }

        /* Map */
        #map {
            height: 100%;
            border-radius: 4px;
            border: 2px solid var(--rc-red);
            /* Grid pattern background for offline mode (visible when no tiles load) */
            background: 
                linear-gradient(rgba(200, 200, 200, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(200, 200, 200, 0.3) 1px, transparent 1px),
                var(--rc-light-gray);
            background-size: 50px 50px;
        }

        .map-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Offline mode notice */
        .offline-notice {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(198, 12, 48, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 1000;
            pointer-events: none;
        }

        .map-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            align-items: center;
        }

        .collapse-btn {
            background: var(--rc-red);
            color: var(--rc-white);
            border: none;
            padding: 6px 10px;
            border-radius: 2px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .collapse-btn:hover {
            background: var(--rc-dark-red);
        }

        /* Filters */
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 8px;
        }

        .filter-group label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        input[type="text"],
        input[type="range"],
        input[type="number"],
        select {
            background: var(--rc-white);
            border: 1px solid var(--rc-red);
            color: var(--rc-black);
            padding: 6px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
        }

        input[type="text"]::placeholder {
            color: #999;
        }

        input[type="range"] {
            padding: 0;
            cursor: pointer;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--rc-dark-red);
            box-shadow: 0 0 0 2px rgba(198, 12, 48, 0.1);
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        .time-preset-btn {
            padding: 5px 10px;
            background: var(--rc-white);
            border: 1px solid var(--rc-red);
            color: var(--rc-red);
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .time-preset-btn:hover {
            background: rgba(198, 12, 48, 0.05);
        }

        .time-preset-btn.active {
            background: var(--rc-red);
            color: var(--rc-white);
        }

        input[type="datetime-local"] {
            background: var(--rc-white);
            border: 1px solid var(--rc-red);
            color: var(--rc-black);
            padding: 6px;
            border-radius: 2px;
            font-size: 11px;
        }

        input[type="datetime-local"]:focus {
            outline: none;
            border-color: var(--rc-dark-red);
            box-shadow: 0 0 0 2px rgba(198, 12, 48, 0.1);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 8px;
        }

        .stat-box {
            background: var(--rc-light-gray);
            padding: 8px;
            border-radius: 2px;
            text-align: center;
            border-left: 3px solid var(--rc-red);
        }

        .stat-label {
            font-size: 9px;
            color: #666;
            margin-bottom: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--rc-red);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--rc-light-gray);
            border-top: 2px solid var(--rc-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltip */
        .leaflet-popup-content-wrapper {
            background: var(--rc-white);
            border: 2px solid var(--rc-red);
        }

        .leaflet-popup-content {
            font-size: 11px;
            color: var(--rc-black);
        }

        .leaflet-popup-content strong {
            color: var(--rc-red);
        }

        /* Marker */
        .marker-bt {
            filter: hue-rotate(200deg) saturate(1.2);
        }

        .marker-wifi {
            filter: hue-rotate(30deg) saturate(1.2);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--rc-light-gray);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--rc-red);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--rc-dark-red);
        }

        .legend {
            font-size: 10px;
            padding: 6px;
            background: var(--rc-white);
            border: 1px solid var(--rc-red);
            border-radius: 2px;
            margin: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 3px 0;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #999;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid var(--rc-red);
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            color: var(--rc-white);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--rc-red);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--rc-red);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--rc-white);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--rc-red);
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-btn-primary {
            background: var(--accent-green);
            color: white;
        }

        .modal-btn-danger {
            background: var(--rc-red);
            color: white;
        }

        .modal-btn-secondary {
            background: #666;
            color: white;
        }

        .analysis-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .analysis-stat {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .analysis-stat-label {
            font-size: 11px;
            color: #999;
        }

        .analysis-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--accent-green);
        }

        .analysis-device-list {
            max-height: 200px;
            overflow-y: auto;
            background: #222;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .analysis-device-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
            font-size: 12px;
        }

        .analysis-device-item:last-child {
            border-bottom: none;
        }

        .analysis-loading {
            text-align: center;
            padding: 40px;
        }

        .analysis-loading i {
            font-size: 32px;
            color: var(--rc-red);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Live Time -->
            <div id="liveTime">--:--:--</div>

            <!-- Status Indicators Panel -->
            <div class="panel">
                <div class="panel-title">
                    <i class="fas fa-heartbeat"></i> Status
                </div>
                <div class="indicators">
                    <div class="indicator" id="gpsIndicator">
                        <div class="indicator-label">GPS Fix</div>
                        <div class="indicator-value error">--</div>
                    </div>
                    <div class="indicator" id="satsIndicator">
                        <div class="indicator-label">Satellites</div>
                        <div class="indicator-value">0</div>
                    </div>
                    <div class="indicator" id="scanModeIndicator">
                        <div class="indicator-label">Scan Mode</div>
                        <div class="indicator-value">--</div>
                    </div>
                    <div class="indicator" id="wifiMonitorIndicator">
                        <div class="indicator-label">WiFi Monitor</div>
                        <div class="indicator-value error">OFF</div>
                    </div>
                </div>
            </div>

            <!-- Pause/Resume Panel -->
            <div class="panel">
                <div class="panel-title" style="display: flex; align-items: center; justify-content: space-between;">
                    <span><i class="fas fa-pause-circle"></i> Updates</span>
                </div>
                <button id="pauseResumeBtn" style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fas fa-play"></i> <span>All Systems Running</span>
                </button>
                <div style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">
                    <span id="pauseStatus">Live updates active</span>
                </div>
            </div>

            <!-- Statistics Panel -->
            <div class="panel">
                <div class="panel-title">
                    <i class="fas fa-chart-bar"></i> Statistics
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">BT Devices</div>
                        <div class="stat-value" id="btDeviceCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">WiFi Devices</div>
                        <div class="stat-value" id="wifiDeviceCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">BT Sightings</div>
                        <div class="stat-value" id="btSightingCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">WiFi Assoc</div>
                        <div class="stat-value" id="wifiAssocCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Data Table with Tabs -->
            <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
                <div class="panel-title">
                    <i class="fas fa-table"></i> Data
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="bt-devices">BT Devices</button>
                    <button class="tab-btn" data-tab="bt-sightings">BT Sightings</button>
                    <button class="tab-btn" data-tab="wifi-devices">WiFi Devices</button>
                    <button class="tab-btn" data-tab="wifi-assoc">WiFi Assoc</button>
                </div>

                <!-- Filters -->
                <div class="filter-group">
                    <input type="text" id="macFilter" placeholder="Filter by MAC..." style="font-size: 11px;">
                    <input type="text" id="ssidFilter" placeholder="Filter by SSID..." style="display: none; font-size: 11px;">
                </div>

                <div class="filter-group">
                    <label>RSSI Range (dBm)</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="range" id="rssiMin" min="-100" max="0" value="-100" style="flex: 1;">
                        <input type="range" id="rssiMax" min="-100" max="0" value="0" style="flex: 1;">
                    </div>
                    <div class="range-values">
                        <span id="rssiMinValue">-100</span>
                        <span id="rssiMaxValue">0</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label>Confidence Range</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="range" id="confidenceMin" min="0" max="100" value="0" style="flex: 1;">
                        <input type="range" id="confidenceMax" min="0" max="100" value="100" style="flex: 1;">
                    </div>
                    <div class="range-values">
                        <span id="confidenceMinValue">0</span>
                        <span id="confidenceMaxValue">100</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label>Confidence Analysis</label>
                    <button id="analyzeConfidenceBtn" style="width: 100%; font-size: 11px; padding: 8px; background: var(--accent-green); color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                        <i class="fas fa-brain"></i> Analyze Confidence
                    </button>
                    <div style="font-size: 10px; color: #666; margin-top: 4px;">
                        Recalculate confidence scores based on device patterns
                    </div>
                </div>

                <div class="filter-group">
                    <label>WiFi Vendor Database</label>
                    <button id="updateOuiBtn" style="width: 100%; font-size: 11px; padding: 8px; background: #9b59b6; color: white; border: none; border-radius: 3px; cursor: pointer; font-weight: bold;">
                        <i class="fas fa-download"></i> Update OUI Database
                    </button>
                    <div style="font-size: 10px; color: #666; margin-top: 4px;">
                        Fetch latest MAC vendor mappings from IEEE (requires internet)
                    </div>
                </div>

                <div class="filter-group">
                    <label>Time Range</label>
                    <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                        <button id="timePreset1h" class="time-preset-btn" data-hours="1">1h</button>
                        <button id="timePreset6h" class="time-preset-btn" data-hours="6">6h</button>
                        <button id="timePreset24h" class="time-preset-btn" data-hours="24">24h</button>
                        <button id="timePresetAll" class="time-preset-btn active" data-hours="0">All</button>
                    </div>
                    <div style="font-size: 11px; margin-bottom: 5px;">Or set custom range:</div>
                    <div style="display: flex; gap: 5px; flex-direction: column;">
                        <input type="datetime-local" id="timeStart" title="Start time" style="font-size: 11px; padding: 4px;">
                        <input type="datetime-local" id="timeEnd" title="End time" style="font-size: 11px; padding: 4px;">
                        <button id="timeRangeApply" style="font-size: 11px; padding: 5px; background: var(--rc-red); color: white; border: none; border-radius: 3px; cursor: pointer;">Apply Range</button>
                    </div>
                </div>

                <!-- Tables -->
                <div id="bt-devices" class="table-container" style="display: block;">
                    <table>
                        <thead>
                            <tr>
                                <th>MAC Address</th>
                                <th>Name</th>
                                <th>Manufacturer</th>
                                <th>Confidence</th>
                                <th>Last Seen</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="btDevicesTable">
                            <tr><td colspan="6" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="bt-sightings" class="table-container" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>MAC</th>
                                <th>RSSI</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="btSightingsTable">
                            <tr><td colspan="3" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="wifi-devices" class="table-container" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>MAC Address</th>
                                <th>Vendor</th>
                                <th>Type</th>
                                <th>Confidence</th>
                                <th>Last Seen</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="wifiDevicesTable">
                            <tr><td colspan="6" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="wifi-assoc" class="table-container" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>MAC</th>
                                <th>SSID</th>
                                <th>Packet Type</th>
                                <th>RSSI</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="wifiAssocTable">
                            <tr><td colspan="5" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Map Type Selector -->
            <div class="panel">
                <div class="panel-title">
                    <i class="fas fa-map"></i> Map Display
                </div>
                <div style="display: flex; gap: 4px;">
                    <button class="tab-btn" id="mapBtBtn" data-map-type="bt" style="flex: 1;">BT</button>
                    <button class="tab-btn active" id="mapWifiBtn" data-map-type="wifi" style="flex: 1;">WiFi</button>
                    <button class="tab-btn" id="mapAllBtn" data-map-type="all" style="flex: 1;">Both</button>
                </div>
            </div>

            <!-- Database Actions -->
            <div class="panel" style="margin-top: auto;">
                <div style="display: flex; gap: 8px; flex-direction: column;">
                    <button id="downloadDbBtn" style="flex: 1; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <i class="fas fa-download"></i> Download DB
                    </button>
                    <button id="purgeDbBtn" style="flex: 1; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <i class="fas fa-trash"></i> Purge DB
                    </button>
                    <button id="clearUsbBtn" style="flex: 1; padding: 10px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <i class="fas fa-hdd"></i> Clear USB
                    </button>
                    
                    <!-- System Control Buttons -->
                    <div style="border-top: 2px solid #ddd; margin-top: 12px; padding-top: 8px;">
                        <button id="updateBtn" style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 8px;">
                            <i class="fas fa-sync-alt"></i> Update
                        </button>
                        <button id="rebootBtn" style="width: 100%; padding: 10px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 8px;">
                            <i class="fas fa-redo"></i> Reboot
                        </button>
                        <button id="shutdownBtn" style="width: 100%; padding: 10px; background: #c0392b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;">
                            <i class="fas fa-power-off"></i> Shutdown
                        </button>
                    </div>
                </div>
                
                <!-- System Status Section -->
                <div style="margin-top: 12px; border-top: 2px solid var(--rc-red); padding-top: 12px;">
                    <div style="font-size: 12px; font-weight: bold; color: var(--rc-red); margin-bottom: 8px;">
                        <i class="fas fa-info-circle"></i> System Status
                    </div>
                    <div id="systemStatus" style="font-size: 11px; line-height: 1.6; color: #666;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span><i class="fas fa-hdd" style="color: #3498db;"></i> Root Disk:</span>
                            <span id="diskRoot">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span><i class="fas fa-usb" style="color: #e74c3c;"></i> USB:</span>
                            <span id="diskUsb">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span><i class="fas fa-database" style="color: #9b59b6;"></i> Database:</span>
                            <span id="dbSize">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span><i class="fas fa-memory" style="color: #2ecc71;"></i> Memory:</span>
                            <span id="memory">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span><i class="fas fa-microchip" style="color: #9b59b6;"></i> CPU:</span>
                            <span id="cpu">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;" id="tempRow">
                            <span><i class="fas fa-thermometer-half" style="color: #e67e22;"></i> Temp:</span>
                            <span id="temperature">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;" id="powerRow">
                            <span><i class="fas fa-bolt" style="color: #f39c12;"></i> Power:</span>
                            <span id="power">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resizable Divider -->
        <div class="divider" id="divider"></div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Map with collapse button -->
            <div class="map-container">
                <div class="map-controls">
                    <div class="panel-title" style="flex: 1; margin: 0;">
                        <i class="fas fa-map-location-dot"></i> Heatmap Overlay
                    </div>
                    <a href="https://github.com/Grupa-Ratownictwa-PCK-Poznan/SAR_BT_Scan" target="_blank" class="collapse-btn" title="About this project">
                        <i class="fas fa-info-circle"></i> About
                    </a>
                </div>
                <div id="map" style="flex: 1;"></div>
                
                <!-- Device Tooltip Popup -->
                <div id="deviceTooltip" class="device-tooltip">
                    <div class="device-tooltip-title">
                        WiFi Device Details
                        <button class="device-tooltip-close" onclick="closeDeviceTooltip()">&times;</button>
                    </div>
                    <div id="deviceTooltipContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS (bundled locally for offline operation) -->
    <script src="/static/js/leaflet.min.js"></script>
    
    <!-- Leaflet.heat plugin for heatmap rendering (bundled locally for offline operation) -->
    <script src="/static/js/leaflet-heat.min.js"></script>

    <!-- Main Application JS -->
    <script>
        // ============= Configuration =============
        const API_BASE = `http://${window.location.host}`;
        console.log("API_BASE:", API_BASE);
        console.log("Leaflet library URL: checking if loaded...");
        console.log("L object available:", typeof L !== 'undefined');
        if (typeof L !== 'undefined') {
            console.log("L.heatLayer available:", typeof L.heatLayer !== 'undefined');
        }
        const WS_PROTOCOL = window.location.protocol === "https:" ? "wss://" : "ws://";
        const WS_URL = `${WS_PROTOCOL}${window.location.host}/ws/live`;

        // ============= State =============
        let map = null;
        let heatmapLayer = null;
        let mapMarkers = [];
        let mapDataType = "wifi";
        let currentTab = "bt-devices";
        let wsConnection = null;
        let sidebarWidth = 380;
        let isDraggingDivider = false;
        let mapMinimized = false;
        let isPaused = false;  // Pause/resume data updates
        
        // WiFi device selection state
        let selectedWiFiDevice = null;  // MAC address of selected device
        let selectedWiFiDeviceData = null;  // Full device data object
        
        // BT device selection state
        let selectedBTDevice = null;  // MAC address of selected BT device
        let selectedBTDeviceData = null;  // Full device data object
        
        // Time filter state
        let currentTimePreset = 0; // hours, 0 = all (DEFAULT)
        let customTimeStart = null; // Unix timestamp
        let customTimeEnd = null;   // Unix timestamp

        // ============= Initialization =============
        function initTimeFilters() {
            // Set default datetime inputs (not used by default since currentTimePreset=0 means ALL)
            // But keep them available for custom range selection
            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 86400000);
            
            document.getElementById("timeEnd").value = now.toISOString().slice(0, 16);
            document.getElementById("timeStart").value = oneDayAgo.toISOString().slice(0, 16);
        }
        
        function getTimeFilterParams() {
            /**Get time filter parameters based on current preset or custom range.
             * Returns object with hours_back (for quick select) or time_start/time_end (for custom range)
             */
            if (customTimeStart && customTimeEnd) {
                return {
                    time_start: customTimeStart.getTime() / 1000,
                    time_end: customTimeEnd.getTime() / 1000
                };
            } else if (currentTimePreset > 0) {
                return { hours_back: currentTimePreset };
            } else {
                // All time - no parameters
                return {};
            }
        }
        
        function initMap() {
            console.log("Initializing map...");
            
            const mapContainer = document.getElementById("map");
            if (!mapContainer) {
                console.error("Map container not found");
                return;
            }
            console.log("Map container found, size:", mapContainer.offsetWidth, "x", mapContainer.offsetHeight);
            
            if (!L) {
                console.error("Leaflet (L) not loaded");
                return;
            }
            console.log("Leaflet library available");
            
            map = L.map("map").setView([51.505, -0.09], 13);
            console.log("Map object created");

            // Try to add OpenStreetMap tiles (will work if online, gracefully fail if offline)
            const tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "© OpenStreetMap contributors",
                maxZoom: 19,
                errorTileUrl: ''  // Don't show broken image icons
            });
            
            // Handle tile loading errors (offline mode)
            let tilesLoaded = false;
            let tilesErrored = false;
            
            tileLayer.on('tileerror', function() {
                if (!tilesErrored) {
                    tilesErrored = true;
                    console.log('Map tiles unavailable - running in offline mode');
                    showOfflineMapNotice();
                }
            });
            
            tileLayer.on('tileload', function() {
                tilesLoaded = true;
            });
            
            tileLayer.addTo(map);
            
            // Check after a delay if any tiles loaded
            setTimeout(() => {
                if (!tilesLoaded && !tilesErrored) {
                    showOfflineMapNotice();
                }
            }, 3000);
            
            console.log("OSM tiles added to map");
            
            // Add event listener for map size changes
            setTimeout(() => {
                map.invalidateSize();
                console.log("Map size invalidated");
            }, 100);

            updateHeatmap();
            console.log("Initial heatmap update called");
        }

        function showOfflineMapNotice() {
            // Add a notice overlay on the map
            const mapContainer = document.querySelector('.map-container');
            if (mapContainer && !document.getElementById('offlineNotice')) {
                const notice = document.createElement('div');
                notice.id = 'offlineNotice';
                notice.className = 'offline-notice';
                notice.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline Mode - Map tiles unavailable';
                mapContainer.appendChild(notice);
            }
        }

        function setupWebSocket() {
            try {
                wsConnection = new WebSocket(WS_URL);

                wsConnection.onopen = () => {
                    console.log("WebSocket connected");
                };

                wsConnection.onmessage = (event) => {
                    if (isPaused) return;  // Skip updates if paused
                    const data = JSON.parse(event.data);
                    if (data.type === "live_update") {
                        updateLiveStatus(data);
                    }
                };

                wsConnection.onerror = (error) => {
                    console.error("WebSocket error:", error);
                };

                wsConnection.onclose = () => {
                    console.log("WebSocket disconnected, reconnecting in 3s...");
                    setTimeout(setupWebSocket, 3000);
                };
            } catch (error) {
                console.error("Failed to connect WebSocket:", error);
                setTimeout(setupWebSocket, 3000);
            }
        }

        // ============= Server Time Display =============
        async function updateLiveTime() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                const serverDate = new Date(data.timestamp_str);
                
                const dateStr = serverDate.toLocaleDateString("en-US", {
                    weekday: "short",
                    month: "short",
                    day: "2-digit"
                });
                const timeStr = serverDate.toLocaleTimeString("en-US", {
                    hour12: false,
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                });
                document.getElementById("liveTime").textContent = `${dateStr} ${timeStr}`;
            } catch (error) {
                console.error("Error fetching server time:", error);
            }
        }

        // ============= Live Status Updates =============
        async function updateLiveStatus(data) {
            // Update GPS indicator
            const gpsIndicator = document.getElementById("gpsIndicator");
            const gpsValue = gpsIndicator.querySelector(".indicator-value");
            if (data.gps.fix_ok) {
                gpsIndicator.className = "indicator active";
                gpsValue.className = "indicator-value good";
                gpsValue.textContent = "✓ FIXED";
            } else {
                gpsIndicator.className = "indicator inactive";
                gpsValue.className = "indicator-value error";
                gpsValue.textContent = "✗ NO FIX";
            }

            // Update satellites
            const satsIndicator = document.getElementById("satsIndicator");
            const satsValue = satsIndicator.querySelector(".indicator-value");
            if (data.gps.sats_used !== null) {
                satsValue.textContent = data.gps.sats_used;
                satsIndicator.className = data.gps.sats_used >= 4 ? "indicator active" : "indicator";
                satsValue.className = data.gps.sats_used >= 4 ? "indicator-value good" : "indicator-value";
            }

            // Update stats
            document.getElementById("btDeviceCount").textContent = data.stats.bt_devices;
            document.getElementById("wifiDeviceCount").textContent = data.stats.wifi_devices;
            document.getElementById("btSightingCount").textContent = data.stats.bt_sightings;
            document.getElementById("wifiAssocCount").textContent = data.stats.wifi_associations;
        }

        // ============= Status Update on Page Load =============
        async function updateStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const status = await response.json();

                // Update GPS
                const gpsIndicator = document.getElementById("gpsIndicator");
                const gpsValue = gpsIndicator.querySelector(".indicator-value");
                if (status.gps.fix_ok) {
                    gpsIndicator.className = "indicator active";
                    gpsValue.className = "indicator-value good";
                    gpsValue.textContent = `✓ MODE ${status.gps.mode}`;
                } else {
                    gpsIndicator.className = "indicator inactive";
                    gpsValue.className = "indicator-value error";
                    gpsValue.textContent = "✗ NO FIX";
                }

                // Update satellites
                const satsIndicator = document.getElementById("satsIndicator");
                const satsValue = satsIndicator.querySelector(".indicator-value");
                satsValue.textContent = status.gps.sats_used ? status.gps.sats_used : "0";
                if (status.gps.sats_used >= 4) {
                    satsIndicator.className = "indicator active";
                    satsValue.className = "indicator-value good";
                }

                // Update scan mode
                const scanModeIndicator = document.getElementById("scanModeIndicator");
                const scanModeValue = scanModeIndicator.querySelector(".indicator-value");
                scanModeValue.textContent = (status.scanner.mode || "N/A").toUpperCase();
                if (status.scanner.mode) {
                    scanModeIndicator.className = "indicator active";
                    scanModeValue.className = "indicator-value good";
                }

                // Update WiFi monitor mode with band detection
                const wifiMonitorIndicator = document.getElementById("wifiMonitorIndicator");
                const wifiMonitorValue = wifiMonitorIndicator.querySelector(".indicator-value");
                if (status.scanner.wifi_monitor_mode) {
                    wifiMonitorIndicator.className = "indicator active";
                    wifiMonitorValue.className = "indicator-value good";
                    const bands = status.scanner.wifi_bands || "unknown";
                    wifiMonitorValue.textContent = `✓ ON (${bands})`;
                } else {
                    wifiMonitorIndicator.className = "indicator inactive";
                    wifiMonitorValue.className = "indicator-value error";
                    wifiMonitorValue.textContent = "✗ OFF";
                }
            } catch (error) {
                console.error("Error updating status:", error);
            }
        }

        // ============= Data Loading Functions =============
        async function loadBTDevices() {
            try {
                const macFilter = document.getElementById("macFilter").value;
                const confidenceMin = parseInt(document.getElementById("confidenceMin").value);
                const confidenceMax = parseInt(document.getElementById("confidenceMax").value);
                const params = new URLSearchParams({
                    limit: 100,
                    ...(macFilter && { mac_filter: macFilter }),
                    ...(confidenceMin !== 0 && { confidence_min: confidenceMin }),
                    ...(confidenceMax !== 100 && { confidence_max: confidenceMax })
                });

                const response = await fetch(`${API_BASE}/api/bt/devices?${params}`);
                const data = await response.json();

                updateBTDevicesTable(data.devices);
            } catch (error) {
                console.error("Error loading BT devices:", error);
            }
        }

        async function loadBTSightings() {
            try {
                const macFilter = document.getElementById("macFilter").value;
                const rssiMin = parseInt(document.getElementById("rssiMin").value);
                const rssiMax = parseInt(document.getElementById("rssiMax").value);
                const timeFilterParams = getTimeFilterParams();

                const params = new URLSearchParams({
                    limit: 500,
                    ...(macFilter && { mac_filter: macFilter }),
                    ...(rssiMin !== -100 && { rssi_min: rssiMin }),
                    ...(rssiMax !== 0 && { rssi_max: rssiMax }),
                    ...timeFilterParams
                });

                const response = await fetch(`${API_BASE}/api/bt/sightings?${params}`);
                const data = await response.json();

                updateBTSightingsTable(data.sightings);
            } catch (error) {
                console.error("Error loading BT sightings:", error);
            }
        }

        async function loadWiFiDevices() {
            try {
                const macFilter = document.getElementById("macFilter").value;
                const confidenceMin = parseInt(document.getElementById("confidenceMin").value);
                const confidenceMax = parseInt(document.getElementById("confidenceMax").value);
                const params = new URLSearchParams({
                    limit: 100,
                    ...(macFilter && { mac_filter: macFilter }),
                    ...(confidenceMin !== 0 && { confidence_min: confidenceMin }),
                    ...(confidenceMax !== 100 && { confidence_max: confidenceMax })
                });

                const response = await fetch(`${API_BASE}/api/wifi/devices?${params}`);
                const data = await response.json();

                updateWiFiDevicesTable(data.devices);
            } catch (error) {
                console.error("Error loading WiFi devices:", error);
            }
        }

        async function loadWiFiAssociations() {
            try {
                const macFilter = document.getElementById("macFilter").value;
                const ssidFilter = document.getElementById("ssidFilter").value;
                const rssiMin = parseInt(document.getElementById("rssiMin").value);
                const rssiMax = parseInt(document.getElementById("rssiMax").value);
                const timeFilterParams = getTimeFilterParams();

                const params = new URLSearchParams({
                    limit: 500,
                    ...(macFilter && { mac_filter: macFilter }),
                    ...(ssidFilter && { ssid_filter: ssidFilter }),
                    ...(rssiMin !== -100 && { rssi_min: rssiMin }),
                    ...(rssiMax !== 0 && { rssi_max: rssiMax }),
                    ...timeFilterParams
                });

                const response = await fetch(`${API_BASE}/api/wifi/associations?${params}`);
                const data = await response.json();

                updateWiFiAssociationsTable(data.associations);
            } catch (error) {
                console.error("Error loading WiFi associations:", error);
            }
        }

        // ============= Table Update Functions =============
        function updateBTDevicesTable(devices) {
            const tbody = document.getElementById("btDevicesTable");
            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No devices found</td></tr>';
                return;
            }

            tbody.innerHTML = devices.map(device => {
                const isSelected = selectedBTDevice === device.mac;
                const confidenceColor = device.confidence > 70 ? "#2ecc71" : device.confidence > 40 ? "#e67e22" : "#e74c3c";
                return `
                    <tr data-mac="${device.mac}" data-name="${device.name || '—'}" data-manufacturer="${device.manufacturer || '—'}" data-last-seen="${device.last_seen}" data-confidence="${device.confidence}" class="bt-device-row ${isSelected ? 'selected' : ''}" style="cursor: pointer;">
                        <td class="mac-addr">${device.mac}</td>
                        <td>${device.name || "—"}</td>
                        <td>${device.manufacturer || "—"}</td>
                        <td>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${device.confidence}%; background: ${confidenceColor};"></div>
                            </div>
                            ${device.confidence}
                        </td>
                        <td>${new Date(device.last_seen * 1000).toLocaleTimeString()}</td>
                        <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${device.notes || ''}">${device.notes || "—"}</td>
                    </tr>
                `;
            }).join("");
            
            // Attach click handlers to each BT device row
            document.querySelectorAll(".bt-device-row").forEach(row => {
                row.addEventListener("click", handleBTDeviceRowClick);
            });
        }

        function updateBTSightingsTable(sightings) {
            const tbody = document.getElementById("btSightingsTable");
            if (sightings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="loading">No sightings found</td></tr>';
                return;
            }

            tbody.innerHTML = sightings.map(s => {
                const rssiPercent = Math.max(0, Math.min(100, (s.rssi + 100)));
                const rssiColor = rssiPercent > 70 ? "#2ecc71" : rssiPercent > 40 ? "#e67e22" : "#e74c3c";
                return `
                    <tr>
                        <td class="mac-addr">${s.mac}</td>
                        <td>
                            <div class="rssi-bar">
                                <div class="rssi-fill" style="width: ${rssiPercent}%; background: ${rssiColor};"></div>
                            </div>
                            ${s.rssi}
                        </td>
                        <td>${new Date(s.timestamp * 1000).toLocaleTimeString()}</td>
                    </tr>
                `;
            }).join("");
        }

        function updateWiFiDevicesTable(devices) {
            const tbody = document.getElementById("wifiDevicesTable");
            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No devices found</td></tr>';
                return;
            }

            tbody.innerHTML = devices.map(device => {
                const isSelected = selectedWiFiDevice === device.mac;
                const confidenceColor = device.confidence > 70 ? "#2ecc71" : device.confidence > 40 ? "#e67e22" : "#e74c3c";
                return `
                    <tr data-mac="${device.mac}" data-vendor="${device.vendor || '—'}" data-device-type="${device.device_type || '—'}" data-last-seen="${device.last_seen}" class="wifi-device-row ${isSelected ? 'selected' : ''}">
                        <td class="mac-addr">${device.mac}</td>
                        <td>${device.vendor || "—"}</td>
                        <td>${device.device_type || "—"}</td>
                        <td>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${device.confidence}%; background: ${confidenceColor};"></div>
                            </div>
                            ${device.confidence}
                        </td>
                        <td>${new Date(device.last_seen * 1000).toLocaleTimeString()}</td>
                        <td style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${device.notes || ''}">${device.notes || "—"}</td>
                    </tr>
                `;
            }).join("");
            
            // Attach click handlers to each row
            document.querySelectorAll(".wifi-device-row").forEach(row => {
                row.addEventListener("click", handleWiFiDeviceRowClick);
            });
        }

        function updateWiFiAssociationsTable(associations) {
            const tbody = document.getElementById("wifiAssocTable");
            if (associations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No associations found</td></tr>';
                return;
            }

            tbody.innerHTML = associations.map(a => {
                const rssiPercent = Math.max(0, Math.min(100, (a.rssi + 100)));
                const rssiColor = rssiPercent > 70 ? "#2ecc71" : rssiPercent > 40 ? "#e67e22" : "#e74c3c";
                const timestamp = new Date(a.timestamp * 1000).toLocaleString();
                const packetTypeBadge = a.packet_type === 'Beacon' 
                    ? '<span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold;">📡 Beacon</span>'
                    : '<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold;">🔍 Probe</span>';
                return `
                    <tr>
                        <td class="mac-addr">${a.mac}</td>
                        <td>${a.ssid}</td>
                        <td>${packetTypeBadge}</td>
                        <td>
                            <div class="rssi-bar">
                                <div class="rssi-fill" style="width: ${rssiPercent}%; background: ${rssiColor};"></div>
                            </div>
                            ${a.rssi}
                        </td>
                        <td>${timestamp}</td>
                    </tr>
                `;
            }).join("");
        }

        function renderHeatmapFallback(points, originalData) {
            console.log("Rendering fallback heatmap with circle markers...");
            try {
                // Clear old markers
                if (mapMarkers.length > 0) {
                    mapMarkers.forEach(m => map.removeLayer(m));
                    mapMarkers = [];
                    console.log("Cleared old markers");
                }
                
                // Create circle markers for each point
                originalData.forEach(point => {
                    const intensity = point.intensity || 0.5;
                    const rssi = point.rssi || -50;
                    
                    // Determine color based on intensity/RSSI
                    let color = "#001aff"; // blue
                    if (intensity > 0.75) color = "#ff0000"; // red
                    else if (intensity > 0.5) color = "#ffff00"; // yellow
                    else if (intensity > 0.25) color = "#00ff00"; // green
                    
                    // Determine radius based on intensity
                    const radius = 5 + (intensity * 15);
                    
                    // Format popup content
                    let popupHTML = `
                        <div style="font-size: 12px; width: 200px;">
                            <b>Signal Details</b><hr style="margin: 5px 0;">
                    `;
                    
                    // Device MAC
                    if (point.mac) {
                        popupHTML += `<b>MAC:</b> ${point.mac}<br>`;
                    }
                    
                    // SSID (for WiFi)
                    if (point.ssid) {
                        popupHTML += `<b>SSID:</b> ${point.ssid}<br>`;
                    }
                    
                    // Packet Type (for WiFi associations)
                    if (point.packet_type) {
                        const typeLabel = point.packet_type === 'Beacon' ? '📡 Beacon (AP)' : '🔍 Probe (Client)';
                        popupHTML += `<b>Packet:</b> ${typeLabel}<br>`;
                    }
                    
                    // Signal strength
                    popupHTML += `<b>Signal:</b> ${rssi} dBm<br>`;
                    popupHTML += `<b>Intensity:</b> ${(intensity * 100).toFixed(0)}%<br>`;
                    
                    // Type (BT or WiFi)
                    popupHTML += `<b>Type:</b> ${point.type === 'assoc' ? 'WiFi' : 'Bluetooth'}<br>`;
                    
                    // Timestamp
                    if (point.timestamp) {
                        const date = new Date(point.timestamp * 1000);
                        popupHTML += `<b>Time:</b> ${date.toLocaleString()}<br>`;
                    }
                    
                    popupHTML += `</div>`;
                    
                    const circleMarker = L.circleMarker([point.lat, point.lon], {
                        radius: Math.min(radius, 20),
                        fillColor: color,
                        color: color,
                        weight: 1,
                        opacity: 0.7,
                        fillOpacity: intensity,
                        title: `${point.mac || 'Unknown'} - ${point.ssid || 'BT'}`
                    });
                    
                    circleMarker.bindPopup(popupHTML);
                    circleMarker.addTo(map);
                    mapMarkers.push(circleMarker);
                });
                
                console.log("Created", mapMarkers.length, "circle markers");
                
                // Fit map to bounds
                if (mapMarkers.length > 0) {
                    const bounds = L.latLngBounds(mapMarkers.map(m => m.getLatLng()));
                    map.fitBounds(bounds.pad(0.1));
                    console.log("Map fitted to marker bounds");
                }
            } catch (err) {
                console.error("Error in fallback heatmap rendering:", err);
            }
        }

        async function updateHeatmap() {
            try {
                // Build query with filters
                const params = new URLSearchParams();
                
                const macFilter = document.getElementById("macFilter")?.value.trim();
                if (macFilter) params.append("mac_filter", macFilter);
                
                const rssiMin = document.getElementById("rssiMin")?.value;
                if (rssiMin && rssiMin != -100) params.append("rssi_min", rssiMin);
                
                const rssiMax = document.getElementById("rssiMax")?.value;
                if (rssiMax && rssiMax != 0) params.append("rssi_max", rssiMax);
                
                const timeParams = getTimeFilterParams();
                Object.entries(timeParams).forEach(([k, v]) => params.append(k, v));
                
                const ssidFilter = document.getElementById("ssidFilter")?.value.trim();
                if (ssidFilter && currentTab === "wifi-assoc") params.append("ssid_filter", ssidFilter);
                
                const apiUrl = `${API_BASE}/api/map/heatmap?${params}`;
                console.log("Fetching heatmap from:", apiUrl);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error("Heatmap API error:", response.status, response.statusText);
                    return;
                }
                const data = await response.json();
                console.log("Heatmap data received:", data.points.length, "points");

                if (!map) {
                    console.error("Map not initialized");
                    return;
                }

                // Remove old heatmap layer (either heat layer or fallback markers)
                if (heatmapLayer) {
                    map.removeLayer(heatmapLayer);
                    heatmapLayer = null;
                    console.log("Removed old heat layer");
                }
                
                if (mapMarkers.length > 0) {
                    mapMarkers.forEach(m => map.removeLayer(m));
                    mapMarkers = [];
                    console.log("Removed old fallback markers");
                }

                if (!data.points || data.points.length === 0) {
                    console.log("No heatmap data available");
                    return;
                }

                const points = data.points.map(p => [p.lat, p.lon, p.intensity]);
                console.log("Creating heat layer with", points.length, "points");
                console.log("Sample point:", points[0]);
                
                if (!L.heatLayer) {
                    console.error("L.heatLayer is not defined - heat.js library may not be loaded");
                    console.log("Using fallback circle marker rendering...");
                    renderHeatmapFallback(points, data.points);
                    return;
                }
                
                heatmapLayer = L.heatLayer(points, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    gradient: {
                        0.0: "blue",
                        0.25: "cyan",
                        0.5: "lime",
                        0.75: "yellow",
                        1.0: "red"
                    }
                }).addTo(map);
                console.log("Heat layer created and added to map");

                // Fit map to bounds
                if (points.length > 0) {
                    const bounds = L.latLngBounds(points.map(p => [p[0], p[1]]));
                    map.fitBounds(bounds.pad(0.1));
                    console.log("Map fitted to bounds:", bounds);
                }
            } catch (error) {
                console.error("Error updating heatmap:", error);
                console.error("Stack trace:", error.stack);
            }
        }

        // ============= WiFi Device Selection Handlers =============
        // ============= BT Device Selection Handlers =============
        async function handleBTDeviceRowClick(e) {
            const row = e.currentTarget;
            const mac = row.getAttribute("data-mac");
            const name = row.getAttribute("data-name");
            const manufacturer = row.getAttribute("data-manufacturer");
            const lastSeen = parseFloat(row.getAttribute("data-last-seen"));
            const confidence = parseInt(row.getAttribute("data-confidence"));

            // If clicking the same device again, deselect it
            if (selectedBTDevice === mac) {
                clearBTDeviceSelection();
                return;
            }

            // Select the new device
            selectedBTDevice = mac;
            selectedBTDeviceData = {
                mac: mac,
                name: name,
                manufacturer: manufacturer,
                last_seen: lastSeen,
                confidence: confidence
            };

            // Update table styling
            document.querySelectorAll(".bt-device-row").forEach(r => r.classList.remove("selected"));
            row.classList.add("selected");

            // Show tooltip with device details
            showBTDeviceTooltip(mac, name, manufacturer, lastSeen, confidence);

            // Filter the map to show only points from this device
            filterMapByBTDevice(mac);
        }

        function showBTDeviceTooltip(mac, name, manufacturer, lastSeen, confidence) {
            const tooltip = document.getElementById("deviceTooltip");
            const contentDiv = document.getElementById("deviceTooltipContent");
            const titleDiv = tooltip.querySelector(".device-tooltip-title");
            
            // Update title to reflect BT device
            titleDiv.innerHTML = `BT Device Details <button class="device-tooltip-close" onclick="closeDeviceTooltip()">&times;</button>`;

            // Build tooltip HTML
            let html = `
                <div class="device-tooltip-row">
                    <span class="device-tooltip-label">MAC:</span>
                    <span class="device-tooltip-value" style="font-family: 'Courier New', monospace;">${mac}</span>
                </div>
            `;

            if (name && name !== "—") {
                html += `
                    <div class="device-tooltip-row">
                        <span class="device-tooltip-label">Name:</span>
                        <span class="device-tooltip-value">${name}</span>
                    </div>
                `;
            }

            if (manufacturer && manufacturer !== "—") {
                html += `
                    <div class="device-tooltip-row">
                        <span class="device-tooltip-label">Manufacturer:</span>
                        <span class="device-tooltip-value">${manufacturer}</span>
                    </div>
                `;
            }

            html += `
                <div class="device-tooltip-row">
                    <span class="device-tooltip-label">Last Seen:</span>
                    <span class="device-tooltip-value">${new Date(lastSeen * 1000).toLocaleString()}</span>
                </div>
            `;

            if (confidence !== undefined && confidence !== null) {
                html += `
                    <div class="device-tooltip-row">
                        <span class="device-tooltip-label">Confidence:</span>
                        <span class="device-tooltip-value">${confidence}%</span>
                    </div>
                `;
            }

            // Add Triangulation Analysis button
            html += `
                <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <button onclick="openTriangulation('${mac}')" 
                            style="width: 100%; padding: 8px 12px; background: var(--rc-red); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-crosshairs"></i> Analyze Location
                    </button>
                </div>
            `;

            contentDiv.innerHTML = html;

            // Position the tooltip
            tooltip.classList.add("show");
            tooltip.style.top = "50px";
            tooltip.style.left = "50%";
            tooltip.style.transform = "translateX(-50%)";
        }

        function clearBTDeviceSelection() {
            selectedBTDevice = null;
            selectedBTDeviceData = null;

            // Remove selected styling from all BT rows
            document.querySelectorAll(".bt-device-row").forEach(row => {
                row.classList.remove("selected");
            });

            // Hide tooltip
            const tooltip = document.getElementById("deviceTooltip");
            tooltip.classList.remove("show");

            // Clear map filter (re-render with all data)
            updateHeatmap();
        }

        function filterMapByBTDevice(mac) {
            // Build query with only the BT device MAC filter
            const params = new URLSearchParams({
                mac_filter: mac,
                data_type: "bt"  // Only show BT sighting points for this device
            });

            const apiUrl = `${API_BASE}/api/map/heatmap?${params}`;
            console.log("Filtering map for BT device:", mac);

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log("Filtered heatmap data received:", data.points.length, "points");

                    if (!map) {
                        console.error("Map not initialized");
                        return;
                    }

                    // Remove old heatmap layer
                    if (heatmapLayer) {
                        map.removeLayer(heatmapLayer);
                        heatmapLayer = null;
                    }

                    if (mapMarkers.length > 0) {
                        mapMarkers.forEach(m => map.removeLayer(m));
                        mapMarkers = [];
                    }

                    if (!data.points || data.points.length === 0) {
                        console.log("No filtered heatmap data available");
                        return;
                    }

                    const points = data.points.map(p => [p.lat, p.lon, p.intensity]);
                    console.log("Creating filtered heat layer with", points.length, "points");

                    if (!L.heatLayer) {
                        console.error("L.heatLayer is not defined");
                        renderHeatmapFallback(points, data.points);
                        return;
                    }

                    heatmapLayer = L.heatLayer(points, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 17,
                        gradient: {
                            0.0: "blue",
                            0.25: "cyan",
                            0.5: "lime",
                            0.75: "yellow",
                            1.0: "red"
                        }
                    }).addTo(map);
                    console.log("Filtered heat layer created and added to map");

                    // Fit map to bounds
                    if (points.length > 0) {
                        const bounds = L.latLngBounds(points.map(p => [p[0], p[1]]));
                        map.fitBounds(bounds.pad(0.1));
                        console.log("Map fitted to filtered bounds");
                    }
                })
                .catch(error => {
                    console.error("Error filtering map:", error);
                });
        }

        // ============= WiFi Device Selection Handlers =============
        async function handleWiFiDeviceRowClick(e) {
            const row = e.currentTarget;
            const mac = row.getAttribute("data-mac");
            const vendor = row.getAttribute("data-vendor");
            const lastSeen = parseFloat(row.getAttribute("data-last-seen"));

            // If clicking the same device again, deselect it
            if (selectedWiFiDevice === mac) {
                clearWiFiDeviceSelection();
                return;
            }

            // Select the new device
            selectedWiFiDevice = mac;
            selectedWiFiDeviceData = {
                mac: mac,
                vendor: vendor,
                last_seen: lastSeen
            };

            // Update table styling
            document.querySelectorAll(".wifi-device-row").forEach(r => r.classList.remove("selected"));
            row.classList.add("selected");

            // Show tooltip with device details
            await showWiFiDeviceTooltip(mac, vendor, lastSeen);

            // Filter the map to show only points from this device
            filterMapByWiFiDevice(mac);
        }

        async function showWiFiDeviceTooltip(mac, vendor, lastSeen) {
            try {
                const tooltip = document.getElementById("deviceTooltip");
                const contentDiv = document.getElementById("deviceTooltipContent");

                // Fetch SSIDs for this device
                let ssids = [];
                try {
                    const response = await fetch(`${API_BASE}/api/wifi/device/${encodeURIComponent(mac)}/ssids`);
                    const data = await response.json();
                    ssids = data.ssids || [];
                } catch (error) {
                    console.error("Error fetching SSIDs:", error);
                }

                // Build tooltip HTML
                let html = `
                    <div class="device-tooltip-row">
                        <span class="device-tooltip-label">MAC:</span>
                        <span class="device-tooltip-value" style="font-family: 'Courier New', monospace;">${mac}</span>
                    </div>
                `;

                if (vendor && vendor !== "—") {
                    html += `
                        <div class="device-tooltip-row">
                            <span class="device-tooltip-label">Vendor:</span>
                            <span class="device-tooltip-value">${vendor}</span>
                        </div>
                    `;
                }

                html += `
                    <div class="device-tooltip-row">
                        <span class="device-tooltip-label">Last Seen:</span>
                        <span class="device-tooltip-value">${new Date(lastSeen * 1000).toLocaleString()}</span>
                    </div>
                `;

                // Add SSIDs section
                if (ssids.length > 0) {
                    html += `
                        <div class="device-tooltip-ssids">
                            <div class="device-tooltip-ssids-title">SSIDs (${ssids.length}):</div>
                    `;
                    ssids.forEach(ssid => {
                        html += `<div class="device-tooltip-ssid-item">${ssid || '<em>Hidden Network</em>'}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `
                        <div class="device-tooltip-ssids">
                            <div class="device-tooltip-ssids-title">SSIDs:</div>
                            <div style="color: #999; font-size: 10px; font-style: italic;">No SSIDs found</div>
                        </div>
                    `;
                }

                // Add Triangulation Analysis button
                html += `
                    <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <button onclick="openTriangulation('${mac}')" 
                                style="width: 100%; padding: 8px 12px; background: var(--rc-red); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="fas fa-crosshairs"></i> Analyze Location
                        </button>
                    </div>
                `;

                contentDiv.innerHTML = html;

                // Position the tooltip near the cursor or in the center
                tooltip.classList.add("show");
                tooltip.style.top = "50px";
                tooltip.style.left = "50%";
                tooltip.style.transform = "translateX(-50%)";

            } catch (error) {
                console.error("Error showing device tooltip:", error);
            }
        }

        function closeDeviceTooltip() {
            clearWiFiDeviceSelection();
            clearBTDeviceSelection();
        }

        function openTriangulation(mac) {
            // Open triangulation page in a new tab
            const url = `/triangulate?mac=${encodeURIComponent(mac)}`;
            window.open(url, '_blank');
        }

        function clearWiFiDeviceSelection() {
            selectedWiFiDevice = null;
            selectedWiFiDeviceData = null;

            // Remove selected styling from all rows
            document.querySelectorAll(".wifi-device-row").forEach(row => {
                row.classList.remove("selected");
            });

            // Hide tooltip
            const tooltip = document.getElementById("deviceTooltip");
            tooltip.classList.remove("show");

            // Clear map filter (re-render with all data)
            updateHeatmap();
        }

        function filterMapByWiFiDevice(mac) {
            // Build query with only the WiFi device MAC filter
            const params = new URLSearchParams({
                mac_filter: mac,
                data_type: "assoc"  // Only show WiFi association points for this device
            });

            const apiUrl = `${API_BASE}/api/map/heatmap?${params}`;
            console.log("Filtering map for WiFi device:", mac);

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    console.log("Filtered heatmap data received:", data.points.length, "points");

                    if (!map) {
                        console.error("Map not initialized");
                        return;
                    }

                    // Remove old heatmap layer
                    if (heatmapLayer) {
                        map.removeLayer(heatmapLayer);
                        heatmapLayer = null;
                    }

                    if (mapMarkers.length > 0) {
                        mapMarkers.forEach(m => map.removeLayer(m));
                        mapMarkers = [];
                    }

                    if (!data.points || data.points.length === 0) {
                        console.log("No filtered heatmap data available");
                        return;
                    }

                    const points = data.points.map(p => [p.lat, p.lon, p.intensity]);
                    console.log("Creating filtered heat layer with", points.length, "points");

                    if (!L.heatLayer) {
                        console.error("L.heatLayer is not defined");
                        renderHeatmapFallback(points, data.points);
                        return;
                    }

                    heatmapLayer = L.heatLayer(points, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 17,
                        gradient: {
                            0.0: "blue",
                            0.25: "cyan",
                            0.5: "lime",
                            0.75: "yellow",
                            1.0: "red"
                        }
                    }).addTo(map);
                    console.log("Filtered heat layer created and added to map");

                    // Fit map to bounds
                    if (points.length > 0) {
                        const bounds = L.latLngBounds(points.map(p => [p[0], p[1]]));
                        map.fitBounds(bounds.pad(0.1));
                        console.log("Map fitted to filtered bounds");
                    }
                })
                .catch(error => {
                    console.error("Error filtering map:", error);
                });
        }

        // ============= Event Listeners =============
        const divider = document.getElementById("divider");
        const sidebar = document.getElementById("sidebar");
        
        document.addEventListener("mousedown", (e) => {
            if (e.target === divider) {
                isDraggingDivider = true;
            }
        });

        document.addEventListener("mousemove", (e) => {
            if (isDraggingDivider) {
                const newWidth = e.clientX;
                if (newWidth > 250 && newWidth < window.innerWidth - 100) {
                    sidebar.style.width = newWidth + "px";
                    sidebarWidth = newWidth;
                }
            }
        });

        document.addEventListener("mouseup", () => {
            isDraggingDivider = false;
        });

        // ============= Database Actions =============
        document.getElementById("downloadDbBtn").addEventListener("click", async () => {
            try {
                const response = await fetch(`${API_BASE}/api/download-db`);
                if (!response.ok) {
                    alert("Error downloading database: " + response.statusText);
                    return;
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "results.db";
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                console.error("Error downloading database:", err);
                alert("Error downloading database: " + err.message);
            }
        });

        document.getElementById("purgeDbBtn").addEventListener("click", async () => {
            const confirmed = confirm("⚠️ WARNING: This will delete ALL data in the database!\n\nA backup will be created as 'results_bak.db'.\n\nAre you sure?");
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/purge-db`, {
                    method: "POST"
                });
                const data = await response.json();
                
                if (!response.ok) {
                    alert("Error purging database: " + (data.error || response.statusText));
                    return;
                }
                
                alert("✅ Database purged successfully!\nBackup saved as: " + data.backup_path);
                
                // Refresh the page to show cleared data
                setTimeout(() => location.reload(), 1000);
            } catch (err) {
                console.error("Error purging database:", err);
                alert("Error purging database: " + err.message);
            }
        });

        document.getElementById("clearUsbBtn").addEventListener("click", async () => {
            const confirmed = confirm("⚠️ WARNING: This will delete ALL files in the USB storage!\n\nAre you sure?");
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/clear-usb-storage`, {
                    method: "POST"
                });
                const data = await response.json();
                
                if (!response.ok) {
                    alert("Error clearing USB storage: " + (data.error || response.statusText));
                    return;
                }
                
                alert("✅ USB storage cleared successfully!");
                
                // Update system status to show new disk space
                updateSystemStatus();
            } catch (err) {
                console.error("Error clearing USB storage:", err);
                alert("Error clearing USB storage: " + err.message);
            }
        });

        // System control buttons
        document.getElementById("updateBtn").addEventListener("click", async () => {
            const confirmed = confirm("⚠️ Update will fetch latest changes from git repository.\n\nContinue?");
            if (!confirmed) return;
            
            const btn = document.getElementById("updateBtn");
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            try {
                const response = await fetch(`${API_BASE}/api/system/update`, {
                    method: "POST"
                });
                const data = await response.json();
                
                if (data.success) {
                    alert("✅ Update completed successfully!\n\nOutput:\n" + (data.output || "No output"));
                } else {
                    alert("⚠️ Update completed with status:\n\n" + (data.error || data.output || "Unknown status"));
                }
            } catch (err) {
                console.error("Error updating system:", err);
                alert("❌ Error updating system: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        });

        document.getElementById("rebootBtn").addEventListener("click", async () => {
            const confirmed = confirm("⚠️ WARNING: System will reboot immediately!\n\nThis will disconnect all active sessions.\n\nContinue?");
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/system/reboot`, {
                    method: "POST"
                });
                const data = await response.json();
                
                if (data.success) {
                    alert("🔄 Reboot initiated! System will restart in a few seconds.");
                    // Disable the UI to prevent further interactions
                    document.body.style.opacity = "0.5";
                    document.body.style.pointerEvents = "none";
                } else {
                    alert("❌ Error initiating reboot: " + (data.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Error rebooting system:", err);
                alert("❌ Error rebooting system: " + err.message);
            }
        });

        document.getElementById("shutdownBtn").addEventListener("click", async () => {
            const confirmed = confirm("⚠️ WARNING: System will shutdown immediately!\n\nYou will need to manually power it back on.\n\nContinue?");
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/system/shutdown`, {
                    method: "POST"
                });
                const data = await response.json();
                
                if (data.success) {
                    alert("⏹️ Shutdown initiated! System will power off in a few seconds.");
                    // Disable the UI to prevent further interactions
                    document.body.style.opacity = "0.5";
                    document.body.style.pointerEvents = "none";
                } else {
                    alert("❌ Error initiating shutdown: " + (data.error || "Unknown error"));
                }
            } catch (err) {
                console.error("Error shutting down system:", err);
                alert("❌ Error shutting down system: " + err.message);
            }
        });

        // System Status Update Function
        async function updateSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/system-status`);
                if (!response.ok) {
                    console.error("Failed to fetch system status");
                    return;
                }
                
                const data = await response.json();
                
                // Format byte sizes to human readable format
                const formatBytes = (bytes) => {
                    if (!bytes) return '-';
                    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                    let size = bytes;
                    let unitIndex = 0;
                    while (size >= 1024 && unitIndex < units.length - 1) {
                        size /= 1024;
                        unitIndex++;
                    }
                    return `${size.toFixed(1)} ${units[unitIndex]}`;
                };
                
                // Update disk space for root
                if (data.disk.root) {
                    const rootPercent = data.disk.root.percent.toFixed(1);
                    const rootFree = formatBytes(data.disk.root.free);
                    document.getElementById("diskRoot").textContent = `${rootPercent}% (${rootFree} free)`;
                }
                
                // Update disk space for USB
                if (data.disk.usb) {
                    const usbPercent = data.disk.usb.percent.toFixed(1);
                    const usbFree = formatBytes(data.disk.usb.free);
                    document.getElementById("diskUsb").textContent = `${usbPercent}% (${usbFree} free)`;
                } else {
                    document.getElementById("diskUsb").textContent = "Not mounted";
                }
                
                // Update database size
                if (data.database_size !== undefined) {
                    const dbSizeFormatted = formatBytes(data.database_size);
                    document.getElementById("dbSize").textContent = dbSizeFormatted;
                }
                
                // Update memory
                const memPercent = data.memory.percent.toFixed(1);
                const memUsed = formatBytes(data.memory.used);
                const memTotal = formatBytes(data.memory.total);
                document.getElementById("memory").textContent = `${memPercent}% (${memUsed} / ${memTotal})`;
                
                // Update CPU
                document.getElementById("cpu").textContent = `${data.cpu.percent.toFixed(1)}%`;
                
                // Update temperature
                if (data.temperature !== null) {
                    document.getElementById("temperature").textContent = `${data.temperature.toFixed(1)}°C`;
                    document.getElementById("tempRow").style.display = "flex";
                } else {
                    document.getElementById("tempRow").style.display = "none";
                }
                
                // Update power draw
                if (data.power_draw !== null) {
                    document.getElementById("power").textContent = `${data.power_draw.toFixed(1)}W`;
                    document.getElementById("powerRow").style.display = "flex";
                } else {
                    document.getElementById("powerRow").style.display = "none";
                }
            } catch (err) {
                console.error("Error updating system status:", err);
            }
        }

        // ============= Event Listeners =============
        document.getElementById("pauseResumeBtn").addEventListener("click", () => {
            isPaused = !isPaused;
            const btn = document.getElementById("pauseResumeBtn");
            const statusSpan = document.getElementById("pauseStatus");
            
            if (isPaused) {
                btn.style.background = "#e74c3c";
                btn.innerHTML = '<i class="fas fa-pause"></i> <span>PAUSED - Data Frozen</span>';
                statusSpan.textContent = "Updates paused - data frozen for analysis";
                statusSpan.style.color = "#e74c3c";
            } else {
                btn.style.background = "#3498db";
                btn.innerHTML = '<i class="fas fa-play"></i> <span>All Systems Running</span>';
                statusSpan.textContent = "Live updates active";
                statusSpan.style.color = "#666";
            }
        });
        
        document.querySelectorAll(".tab-btn[data-tab]").forEach(btn => {
            btn.addEventListener("click", (e) => {
                document.querySelectorAll(".tab-btn[data-tab]").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");

                document.querySelectorAll("[id^='bt-'], [id^='wifi-']").forEach(el => {
                    el.style.display = "none";
                });

                currentTab = e.target.dataset.tab;
                document.getElementById(currentTab).style.display = "block";

                // Load data based on current tab
                if (currentTab === "bt-devices") loadBTDevices();
                else if (currentTab === "bt-sightings") loadBTSightings();
                else if (currentTab === "wifi-devices") loadWiFiDevices();
                else if (currentTab === "wifi-assoc") loadWiFiAssociations();
            });
        });

        document.querySelectorAll("[data-map-type]").forEach(btn => {
            btn.addEventListener("click", (e) => {
                document.querySelectorAll("[data-map-type]").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");
                mapDataType = e.target.dataset.mapType;
                updateHeatmap();
            });
        });

        // Filter listeners
        document.getElementById("macFilter").addEventListener("input", () => {
            if (currentTab.includes("bt")) loadBTDevices();
            else if (currentTab.includes("wifi")) loadWiFiDevices();
            updateHeatmap();
        });

        document.getElementById("ssidFilter").addEventListener("input", () => {
            loadWiFiAssociations();
            updateHeatmap();
        });

        document.getElementById("rssiMin").addEventListener("input", (e) => {
            document.getElementById("rssiMinValue").textContent = e.target.value;
            if (currentTab === "bt-sightings") loadBTSightings();
            else if (currentTab === "wifi-assoc") loadWiFiAssociations();
            updateHeatmap();
        });

        document.getElementById("rssiMax").addEventListener("input", (e) => {
            document.getElementById("rssiMaxValue").textContent = e.target.value;
            if (currentTab === "bt-sightings") loadBTSightings();
            else if (currentTab === "wifi-assoc") loadWiFiAssociations();
            updateHeatmap();
        });

        document.getElementById("confidenceMin").addEventListener("input", (e) => {
            document.getElementById("confidenceMinValue").textContent = e.target.value;
            if (currentTab === "bt-devices") loadBTDevices();
            else if (currentTab === "wifi-devices") loadWiFiDevices();
        });

        document.getElementById("confidenceMax").addEventListener("input", (e) => {
            document.getElementById("confidenceMaxValue").textContent = e.target.value;
            if (currentTab === "bt-devices") loadBTDevices();
            else if (currentTab === "wifi-devices") loadWiFiDevices();
        });

        // Time preset buttons
        document.querySelectorAll(".time-preset-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                document.querySelectorAll(".time-preset-btn").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");
                currentTimePreset = parseInt(e.target.dataset.hours);
                customTimeStart = null;
                customTimeEnd = null;
                
                // Reset datetime inputs
                initTimeFilters();
                
                loadBTDevices();
                loadBTSightings();
                loadWiFiDevices();
                loadWiFiAssociations();
                updateHeatmap();
            });
        });

        // Custom time range
        document.getElementById("timeRangeApply").addEventListener("click", () => {
            const startStr = document.getElementById("timeStart").value;
            const endStr = document.getElementById("timeEnd").value;
            
            if (!startStr || !endStr) {
                alert("Please select both start and end times");
                return;
            }
            
            customTimeStart = new Date(startStr);
            customTimeEnd = new Date(endStr);
            currentTimePreset = 0; // Disable preset
            
            // Deactivate all preset buttons
            document.querySelectorAll(".time-preset-btn").forEach(b => b.classList.remove("active"));
            
            loadBTDevices();
            loadBTSightings();
            loadWiFiDevices();
            loadWiFiAssociations();
            updateHeatmap();
        });

        // Show SSID filter only for WiFi associations
        document.querySelectorAll(".tab-btn[data-tab]").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const ssidFilter = document.getElementById("ssidFilter");
                if (e.target.dataset.tab === "wifi-assoc") {
                    ssidFilter.style.display = "block";
                } else {
                    ssidFilter.style.display = "none";
                }
            });
        });

        // ============= Initialization on Page Load =============
        window.addEventListener("load", () => {
            initMap();
            updateStatus();
            updateLiveTime();
            setupWebSocket();
            updateSystemStatus();
            
            // Load initial data
            loadBTDevices();
            
            // Update clock every second
            setInterval(updateLiveTime, 1000);
            
            // Update system status every 5 seconds
            setInterval(updateSystemStatus, 5000);
            
            // Refresh data periodically
            setInterval(() => {
                if (isPaused) return;  // Skip updates if paused
                if (currentTab === "bt-devices") loadBTDevices();
                else if (currentTab === "bt-sightings") loadBTSightings();
                else if (currentTab === "wifi-devices") loadWiFiDevices();
                else if (currentTab === "wifi-assoc") loadWiFiAssociations();
                
                updateHeatmap();
                updateStatus();
            }, 5000);
        });

        // ============= Confidence Analysis Modal =============
        // Note: Elements are retrieved lazily because modal HTML is at end of document
        function getAnalysisModal() {
            return document.getElementById("analysisModal");
        }
        
        function getAnalysisModalContent() {
            return document.getElementById("analysisModalContent");
        }
        
        function showAnalysisModal() {
            const modal = getAnalysisModal();
            if (modal) modal.classList.add("active");
        }
        
        function hideAnalysisModal() {
            const modal = getAnalysisModal();
            if (modal) modal.classList.remove("active");
        }
        
        function renderAnalysisLoading() {
            const content = getAnalysisModalContent();
            if (content) content.innerHTML = `
                <div class="analysis-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Analyzing device patterns...</p>
                </div>
            `;
        }
        
        function renderAnalysisPreview(data) {
            const highConfidence = data.devices?.high_confidence || 0;
            const lowConfidence = data.devices?.low_confidence || 0;
            const btTotal = data.devices?.bt_total || 0;
            const wifiTotal = data.devices?.wifi_total || 0;
            
            let deviceListHtml = '';
            if (data.devices_detail && data.devices_detail.length > 0) {
                deviceListHtml = `
                    <h4 style="margin-top: 15px;">Top Changes:</h4>
                    <div class="analysis-device-list">
                        ${data.devices_detail.slice(0, 15).map(d => `
                            <div class="analysis-device-item">
                                <span class="mac-addr">[${d.type.toUpperCase()}] ${d.mac}</span>
                                <span>${d.old_confidence} → <strong style="color: ${d.new_confidence >= 70 ? '#2ecc71' : d.new_confidence <= 30 ? '#e74c3c' : '#e67e22'}">${d.new_confidence}</strong></span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const content = getAnalysisModalContent();
            if (content) content.innerHTML = `
                <p>Analysis complete. Review the results below:</p>
                
                <div class="analysis-stats">
                    <div class="analysis-stat">
                        <div class="analysis-stat-label">Session Duration</div>
                        <div class="analysis-stat-value">${data.session?.duration_human || 'N/A'}</div>
                    </div>
                    <div class="analysis-stat">
                        <div class="analysis-stat-label">Total Devices</div>
                        <div class="analysis-stat-value">${btTotal + wifiTotal}</div>
                    </div>
                    <div class="analysis-stat">
                        <div class="analysis-stat-label">High Confidence (≥70)</div>
                        <div class="analysis-stat-value" style="color: #2ecc71;">${highConfidence}</div>
                    </div>
                    <div class="analysis-stat">
                        <div class="analysis-stat-label">Low Confidence (≤30)</div>
                        <div class="analysis-stat-value" style="color: #e74c3c;">${lowConfidence}</div>
                    </div>
                </div>
                
                ${deviceListHtml}
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" onclick="hideAnalysisModal()">Cancel</button>
                    <button class="modal-btn modal-btn-danger" onclick="applyAnalysis()">
                        <i class="fas fa-check"></i> Apply Changes
                    </button>
                </div>
            `;
        }
        
        function renderAnalysisSuccess(data) {
            const btUpdated = data.updates?.bt_updated || 0;
            const wifiUpdated = data.updates?.wifi_updated || 0;
            
            const content = getAnalysisModalContent();
            if (content) content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-check-circle" style="font-size: 48px; color: #2ecc71;"></i>
                    <h3 style="margin-top: 15px;">Analysis Complete!</h3>
                    <p>Confidence scores have been updated.</p>
                    
                    <div class="analysis-stats" style="margin-top: 20px;">
                        <div class="analysis-stat">
                            <div class="analysis-stat-label">BT Devices Updated</div>
                            <div class="analysis-stat-value">${btUpdated}</div>
                        </div>
                        <div class="analysis-stat">
                            <div class="analysis-stat-label">WiFi Devices Updated</div>
                            <div class="analysis-stat-value">${wifiUpdated}</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-primary" onclick="hideAnalysisModal(); loadBTDevices(); loadWiFiDevices();">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            `;
        }
        
        function renderAnalysisError(error) {
            const content = getAnalysisModalContent();
            if (content) content.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c;"></i>
                    <h3 style="margin-top: 15px;">Analysis Failed</h3>
                    <p style="color: #e74c3c;">${error}</p>
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" onclick="hideAnalysisModal()">Close</button>
                </div>
            `;
        }
        
        async function startAnalysisPreview() {
            showAnalysisModal();
            renderAnalysisLoading();
            
            try {
                const response = await fetch(`${API_BASE}/api/analyze/confidence/preview`);
                const data = await response.json();
                
                if (data.error) {
                    renderAnalysisError(data.error);
                } else {
                    renderAnalysisPreview(data);
                }
            } catch (error) {
                renderAnalysisError(error.message);
            }
        }
        
        async function applyAnalysis() {
            renderAnalysisLoading();
            
            try {
                const response = await fetch(`${API_BASE}/api/analyze/confidence`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.error) {
                    renderAnalysisError(data.error);
                } else {
                    renderAnalysisSuccess(data);
                }
            } catch (error) {
                renderAnalysisError(error.message);
            }
        }
        
        // Setup analysis modal event listeners after DOM is ready
        document.addEventListener("DOMContentLoaded", () => {
            // Analyze button event listener
            const analyzeBtn = document.getElementById("analyzeConfidenceBtn");
            if (analyzeBtn) {
                analyzeBtn.addEventListener("click", startAnalysisPreview);
            }
            
            // OUI Update button event listener
            const ouiBtn = document.getElementById("updateOuiBtn");
            if (ouiBtn) {
                ouiBtn.addEventListener("click", updateOuiDatabase);
            }
            
            // Close modal on overlay click
            const modal = document.getElementById("analysisModal");
            if (modal) {
                modal.addEventListener("click", (e) => {
                    if (e.target === modal) {
                        hideAnalysisModal();
                    }
                });
            }
        });
        
        // Update OUI Database function
        async function updateOuiDatabase() {
            const btn = document.getElementById("updateOuiBtn");
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                btn.disabled = true;
                
                const response = await fetch("/api/oui/update", { method: "POST" });
                const result = await response.json();
                
                if (response.ok) {
                    alert(`OUI database updated successfully!\n\nEntries: ${result.entries || 'N/A'}\n\nRun 'Analyze Confidence' to apply vendor lookups to WiFi devices.`);
                } else {
                    alert(`Failed to update OUI database: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert(`Error updating OUI database: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Close modal on Escape key (can be set up immediately)
        document.addEventListener("keydown", (e) => {
            const modal = getAnalysisModal();
            if (e.key === "Escape" && modal && modal.classList.contains("active")) {
                hideAnalysisModal();
            }
        });
    </script>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-brain"></i> Confidence Analysis</h2>
                <button class="modal-close" onclick="hideAnalysisModal()">&times;</button>
            </div>
            <div class="modal-body" id="analysisModalContent">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>
